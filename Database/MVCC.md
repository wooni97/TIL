### 동시성 제어(Concurrency Control)란

DBMS가 다수의 사용자 사이에서 동시에 작용하는 다중 트랜잭션의 상호간섭 작용에서 데이터베이스를 보호하는 것을 의미한다.

동시성 제어를 할 수 있도록 아래와 같은 기능을 통해 트랜잭션의 격리성 수준을 조정할 수 있도록 한다.

- Lock 기능
- SET TRANSACTION 명령어

동시성을 제어하는 방법은 낙관적 동시성 제어와 비관적 동시성 제어가 있다.

### 낙관적 동시성 제어(Optimistic Concurrency Control)

- 사용자들이 같은 데이터를 동시에 수정하지 않을 것이라고 가정한다.
- 데이터를 읽는 시점에 Lock을 걸지 않는 대신 수정 시점에 값이 변경됐는지를 반드시 검사한다.

### 비관적 동시성 제어(Pessimistic Concurrency Control)

- 사용자들이 같은 데이터를 동시에 수정할 것이라고 가정한다.
- 데이터를 읽는 시점에 락을 걸고, 트랜잭션이 완료될 때까지 이를 유지한다.
- SELECT 시점에 락을 거는 비관적 동시성 제어는 시스템의 동시성을 심각하게 떨어뜰리 수 있어서 wait, nowait 옵션과 함께 사용해야 함

동시성 제어의 목표는 동시에 실행되는 트랜잭션 수를 최대화 하면서 입력, 수정, 삭제, 검색시 데이터의 무결성을 유지하는데 있다.

---

### 공유락(Shared Lock)과 배타락(Exclusive Lock)

비관적 동시성 제어를 위한 대표적인 방법으로 Lock이 있는데, 크게 공유락과 배타락이 있다.

- 공유락 : 읽기 잠금
- 배타락 : 쓰기 잠금

### 공유락(Shared Lock)

공유 락이 걸린 데이터에 대해서는 읽기 연산(SELECT)만 실행 가능하며, 쓰기 연산은 실행이 불가능하다. 공유 락이 걸린 데이터에 대해서는 다른 트랜잭션도 똑같이 공유 락을 획득할 수 있으나, 배타 락은 획득할 수 없다.

공유 락을 사용하면, 조회한 데이터가 트랜잭션 내내 변경되지 않음을 보장한다.

### 배타락(Exclusive Lock)

데이터에 대해 배타 락을 획득한 트랜잭션은 읽기 연산과 쓰기 연산을 모두 실행할 수 있다. 다른 트랜잭션은 배타 락이 걸린 데이터에 대해 읽기 작업도, 쓰기 작업도 수행할 수 없다. 즉, 배타 락이 걸려 있다면 다른 트랜잭션은 공유 락, 배타 락 둘다 획득할 수 없다. 배타 락을 획득한 트랜잭션은 해당 데이터에 대해 독점권을 갖는 것이다.

### Locking 메커니즘의 문제점

- 읽기 작업과 쓰기 작업이 서로 방해를 일으키기 때문에 동시성 문제가 발생한다.
- 데이터 일관성에 문제가 생기는 경우도 있어서 Lock을 더 오래 유지하거나 테이블 레벨의 Lock을 사용해야 하고, 동시성 저하가 발생한다.

이러한 문제점을 해결하기 위해 MVCC(Multi-Version Concurrency Control, 다중 버전 동시성 제어)가 탄생하게 되었다.

---

### MVCC(Multi-Version Concurrency Control)

MVCC는 동시 접근을 허용하는 데이터베이스에서 동시성을 제어하기 위해 사용하는 방법 중 하나이다. MVCC에서 데이터에 접근하는 사용자는 접근한 시점에 데이터베이스의 Snapshot을 읽는다. 이 스냅샷 데이터에 대한 변경이 완료(커밋)될 때 까지의 변경사항은 다른 데이터베이스 사용자가 볼 수 없다.

이후에 사용자가 업데이트하면 이전의 데이터를 덮어 씌우는게 아니라 새로운 버전의 데이터를 UNDO 영역에 생성한다. 대신 이전 버전의 데이터와 비교해서 변경된 내용을 기록한다.

이렇게 하나의 데이터에 대해 여러 버전의 데이터가 존재하게 되고, 사용자는 마지막 버전의 데이터를 읽게 된다.

MVCC의 접근 방식은 잠금을 필요로 하지 않기 때문에 일반적인 RDBMS보다 매우 빠르게 작동한다. 또한 데이터를 읽기 시작할 때, 다른 사람이 그 데이터를 삭제하거나 수정하더라도 영향을 받지 않고 데이터를 사용할 수있다. 대신 사용하지 않는 데이터가 계속 쌓이게 되므로 데이터를 정리하는 시스템이 필요하다. MVCC 모델은 하나의 데이터에 대한 여러 버전의 데이터를 허용하기 때문에 데이터 버전이 충돌될 수 있으므로 애플리케이션 영역에서 이러한 문제를 해결해야 한다.

MVCC는 문장수준과 트랜잭션 수준의 읽기 일관성이 존재한다.