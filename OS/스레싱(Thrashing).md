# Thrashing

## Thrashing

---

### Thrashing(스레싱)이란?

**스레싱이란 페이지 부재율이 증가하여 CPU 이용율이 급격하게 떨어지는 현상을 말한다.**

CPU 이용율이 낮다는 것은 메모리에 올라와 있는 프로세스의 수가 너무 적어 프로세스가 모두 I/O 작업을 함으로써 준비 큐가 비는 경우가 발생했다는 것이다.


어느 한계점까지는 CPU 이용율이 증가하다가 한계점 이상부터는 이용율이 떨어지게 된다. 그 이유가 스레싱 때문이다.

### Thrashing 발생 원인

프로세스를 처리하는 시간보다 메모리에 적재되지 못한 페이지로 인하여 페이지 교체에 드는 시간이 증가하게 되고 그로 인해 CPU 이용율이 떨어진다.

운영체제는 CPU 이용율이 낮으면 다중 프로그래밍 정도(Multi-Programming Degree, MPD)를 높이게 된다. 이때 동시에 실행하는 프로세스가 많아질 수록 각 프로세스에 할당된 메모리 페이지 프레임들은 더욱 감소하게 된다. 프로세스가 원활하게 수행하려면 필요한 최소한의 페이지 프레임들이 있다. 그런데 각 프로세스가 수행에 필요한 최소한의 페이지 프레임도 할당 받지 못하게 되어 페이지 부재가 빈번하게 발생될 것이다.

페이지 부재가 발생하면 스왑 영역에서 해당 페이지를 메모리로 가져오기 위해 디스크 I/O 작업이 발생하고 문맥 교환을 통해 다른 프로세스에게 CPU가 이양 된다. 이때 다른 프로세스 역시 할당 받은 메모리 양이 지나치게 적으면 페이지 부재가 발생할 수 밖에 없게 된다. 결국에는 준비 큐에 있는 모든 프로세스에게 CPU가 한 차례씩 할당되었는데도 모든 프로세스가 페이지 부재를 발생시켜 시스템은 페이지 부재를 처리하느라 매우 분주해지고 CPU 이용율을 급격히 떨어지게 된다.

이 상황에서 운영체제는 메모리에 올라와 있는 프로세스의 수가 적어 이러한 현상이 발생했다고 판단하고, MPD를 높이기 위해 또 다른 프로세스를 메모리에 추가하게 된다. 이로 인해 프로세스당 할당된 프레임의 수가 더욱 감소하고 페이지 부재는 더욱 빈번히 발생하게 된다.

<aside>
💡 **요약 :** 운영체제는 CPU 이용율이 낮으면 MPD를 높이게 된다. 이로 인해 각 프로세스에 할당된 메모리 페이지 프레임이 감소하여 페이지 부재가 빈번하게 발생한다. 시스템은 페이지 부재를 처리하느라 분주해지고 CPU 이용율이 급격하게 떨어지게 된다.

</aside>

## Thrashing 발생 방지 알고리즘

---

스레싱은 각 프로세스에 프레임을 할당하는 정도와도 관련이 있다.

실행 중인 여러 프로세스에 프레임을 얼마나 나누어주냐에 따라 시스템의 성능이 달라진다.

너무 적은 프레임을 할당하면 페이지 부재가 자주 일어나게 될 것이고, 너무 많은 프레임을 할당하면 메모리가 낭비되어 전체적인 시스템에 영향으 ㄹ끼친다.

그래서 남아 있는 프레임을 실행 중인 프로세스에게 적절하게 나누어주는 정책이 필요한데 이를 위해 **정적할당과 동적할당**이 존재한다.

### 정적 할당

정적 할당은 프로세스 실행 초기에 프레임을 나누어준 후 그 크기를 고정하는 것으로 균등 할당 방식과 비례 할당 방식이 있다.

> **균등 할당 방식**
>

균등 할당 방식은 프로세스의 크기에 상관없이 모든 프로세스들에게 동등하게 사용가능한 프레임을 나누어주는 것이다.

예를 들어 현재 물리 메모리에 사용가능한 프레임이 15개 있고 프로세스 A, B, C가 존재할 때 각각 프로세스가 필요로 하는 프레임의 크기는 상관하지 않고 15개를 3분할 하여 각각 프로세스에게 5개씩 할당하는 방식이다.

이러한 균등 할당 방식은 어떠한 프로세스는 필요로 하는 것보다 많은 프레임을 할당받고 어떠한 프로세스는 필요로 하는 프레임보다 적게 할당받아 페이지 부재가 빈번하게 발생할 가능성이 커지는 단점이 존재한다.

> **비례 할당 방식**
>

비례 할당 방식은 프로세스의 크기에 비례하여 프레임을 할당하는 방식이다.

**그러나 정적 할당 방식은 문제점이 존재한다.**

1) 프로세스가 실행 중에 필요로 하는 프레임을 유동적으로 반영하지 못한다.

예를 들어, 동영상 플레이어같은 경우에는 프로그램 자체는 프로세스의 크기가 작아 그에 맞는 프레임을 실행 초기에 할당받을 것이다. 하지만, 동영상 재생을 위해 용량이 큰 동영상을 불러온다면 더 많은 프레임이 요구된다. 이러한 경우에 정적 할당 방식은 프로세스가 실행되면서 유동적으로 프레임을 반영하지 못한다.

2) 사용하지 않은 메모리를 처음부터 미리 확보하여 공간을 낭비한다.

정적 할당 방식은 큰 프로세스를 실행하면서 당장 필요 없는 프레임을 미리 할당하기 때문에 메모리가 낭비된다.

### 동적 할당

정작 할당에는 단점들이 존재한다. 프로세스가 실행 중일때 필요한 프레임의 갯수가 달라질 수 있는데 이러한 상황을 고려하여 프레임을 할당하는 방식이 동적 할당 방식이다.

동적 할당 방식에는 **워킹셋 알고리즘**과 **페이지 부재 빈도 알고리즘**이 있다.

### 워킹셋 알고리즘

워킹셋은 한꺼번에 올라가야 하는 페이지들의 집합이다. 워킹셋 알고리즘은 프로세스의 워킹셋을 구성하는 페이지들이 한꺼번에 올라갈 수 있을 메모리 공간이 있을때만 동작한다.

프로세스가 일정 시간 동안 집중적으로 특정 주소 영역을 참조하는 경향이 있는데 이를 지역성의 원리라고 한다. 그리고 지역성의 원리에 따라 참조되는 영역을 지역성 집합이라고 한다. 워킹셋 알고리즘은 지역성 집합이 메모리에 동시에 올라갈 수 있도록 보장하는 메모리 관리 알고리즘이다.


워킹셋 알고리즘에서 한꺼번에 메모리에 올라가야 할 페이지들의 집합을 결정하기 위해 워킹셋 윈도우를 사용한다. 윈도우의 크기를 Δ라고 할 때, 워킹셋 알고리즘은 시각 t에서 Δ이전에 참조된 **[Δ-t, t]** 사이에 참조된 페이지들의 집합으로 결정된다.

워킹셋 윈도우의 크기를 조절하여 워킹셋의 크기를 조절하는 방법으로 프로세스가 메모리를 많이 필요로 할때는 많이 할당하고 적게 필요로 할 때에는 적게 할당하는 동적인 프레임 할당 기능을 수행하게 된다.

### 페이지 부재 빈도 알고리즘

프로세스의 페이지 부재율을 주기적으로 조사하고 이 값에 근거해서 프로세스가 필요로 하는 프레임의 양을 동적으로 조절하는 알고리즘이다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/0747e310-4032-4588-a306-7faef82d958b/9b2b0847-4b21-411f-9a02-e98ade291d14/Untitled.png)

페이지 부재 횟수를 기록하여 프로세스마다 페이지 부재 비율을 계산한다.

페이지 부재 비율의 상한선과 하한선을 설정한다. 만약 페이지 부재 비율이 상한선을 초과하면 할당한 프레임이 적다는 것이므로 프레임 할당량을 늘려준다. 반대로 페이지 부재 비율이 하한선보다 낮다면 할당한 프레임을 일정 회수한다.

**스터디 내용 +)**

페이지를 이용하면 부모 프로세스의 메모리 공간을 복사하지 않고도 부모와 동일한 코드 및 데이터 영역을 가리킬 수 있다.

부모의 페이지 테이블을 복사하는 방식을 통해 데이터 영역은 복사하지 않아도 같은 논리주소와 같은 물리 주소를 공유하기 때문에 fork 로 인한 문제점을 갖지 않는다.

그래서 데이터를 쓰지 않고 읽기 작업만 한다면 이 상태가 지속되고 부모나 자식 프로세스에서 새로운 쓰기 작업이 발생하면 해당 페이지가 별도의 공간으로 복제된다